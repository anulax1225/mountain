<template class="">
    <div class="px-10 py-10">
        <div class="flex justify-between items-center mb-2">
            <mx-button @click="showArchives.value = !showArchives.value">
                <p x-format>{{ showArchives.value ? 'Hidde archives' : 'Show archives' }}</p>
            </mx-button>
            <mx-input x-model="searchQuery.value" placeholder="Rechercher un projet..." class="w-fit"></mx-input>
        </div>
        <template x-component:table="column">
            <div class="flex items-center">
                <slot></slot>
            </div>
            <script setup>
                const columnProps = defineProps({
                    sort: {
                        type: Boolean,
                        default: false,
                    },
                    direction: {
                        type: Boolean,
                        default: false,
                    }
                })
            </script>
        </template>
        <div class="grid grid-cols-10 border-y bg-gray-100 border-gray-200 py-2 font-semibold text-center">
            <p class="col-span-1">N° RD</p>
            <p class="col-span-1">N° Project</p>
            <p class="col-span-3">Nom du projet</p>
            <p class="col-span-3">Client</p>
            <p class="col-span-2">Lieu</p>
        </div>
        <div class="w-full max-h-[80vh] overflow-y-auto text-center">
            <template x-for="(project, index) in projects.value" :key="index">
                <div class="grid grid-cols-10 hover:bg-gray-50" :class="index < projects.value.length - 1 ? 'border-b' : ''">
                    <p class="col-span-1 border-r py-1.5" x-format>{{ project.code }}</p>
                    <p class="col-span-1 border-r py-1.5" x-format>{{ project.code_ext }}</p>
                    <p class="col-span-3 border-r py-1.5" x-format>{{ project.nom }}</p>
                    <p class="col-span-3 border-r py-1.5" x-format>{{ project.client }}</p>
                    <p class="col-span-2 py-1.5" x-format>{{ project.lieu }}</p>
                </div>
            </template>
        </div>
    </div>
</template>
<script setup>
    const props = defineProps({
        projects: {
            type: Array,
            default: []
        }
    });
    const showArchives = ref(false);
    const searchQuery = ref("");

    const includesSearchQuery = (project) => {
        let includes = false;
        Object.entries(project)
        .filter(([key, value]) => typeof value === "string")
        .map(([key, value]) => {
            return value.toLowerCase().includes(searchQuery.value.toLowerCase())
        })
        .forEach(check => includes = check || includes ? true : false);
        return includes;
    }

    return {
        searchQuery,
        showArchives,
        projects: computed(() => {
            let projects  = props.projects.filter(project => project.est_archiver <= (showArchives.value ? 1 : 0));
            if (searchQuery.value) projects = projects.filter(project => includesSearchQuery(project))
            return projects;
        }),
        dateCompare(val1, val2) {
            const parseDate = (dateStr) => {
                if (!dateStr) return null;
                const parts = dateStr.split('.');
                if (parts.length !== 3) return null;
                return new Date(parts[2], parts[1] - 1, parts[0]);
            };

            val1 = parseDate(val1);
            val2 = parseDate(val2);

            if (!val1 && !val2) return 0;
            if (!val1 && val2) return -1;
            if (!val2 && val1) return 1;
            if (val1 > val2) return 1;
            if (val1 < val2) return -1;
            return 0;
        },

        textCompare(val1, val2) {
            if (!val1 && !val2) return 0;
            if (!val1 && val2) return -1;
            if (!val2 && val1) return 1;
            if (val1 > val2) return 1;
            if (val1 < val2) return -1;
            return 0;
        },

        numberCompare(val1, val2) {
            val1 = parseInt(val1);
            val2 = parseInt(val2);
            if (!val1 && !val2) return 0;
            if (!val1 && val2) return -1;
            if (!val2 && val1) return 1;
            if (val1 > val2) return 1;
            if (val1 < val2) return -1;
            return 0;
        }
    }
</script>